var qq=qq||{};qq.extend=function(b,a){for(var c in a){b[c]=a[c]}};qq.indexOf=function(b,c,d){if(b.indexOf){return b.indexOf(c,d)}d=d||0;var a=b.length;if(d<0){d+=a}for(;d<a;d++){if(d in b&&b[d]===c){return d}}return -1};qq.obj2url=function(f,b,h){var g=[],d="&",e=function(k,j){var l=b?(/\[\]$/.test(b))?b:b+"["+j+"]":j;if((l!="undefined")&&(j!="undefined")){g.push((typeof k==="object")?qq.obj2url(k,l,true):(Object.prototype.toString.call(k)==="[object Function]")?encodeURIComponent(l)+"="+encodeURIComponent(k()):encodeURIComponent(l)+"="+encodeURIComponent(k))}};if(!h&&b){d=(/\?/.test(b))?(/\?$/.test(b))?"":"&":"?";g.push(b);g.push(qq.obj2url(f))}else{if((Object.prototype.toString.call(f)==="[object Array]")&&(typeof f!="undefined")){for(var c=0,a=f.length;c<a;++c){e(f[c],c)}}else{if((typeof f!="undefined")&&(f!==null)&&(typeof f==="object")){for(var c in f){e(f[c],c)}}else{g.push(encodeURIComponent(b)+"="+encodeURIComponent(f))}}}return g.join(d).replace(/^&/,"").replace(/%20/g,"+")};qq.UploadHandlerAbstract=function(a){this._options={debug:false,action:"/upload.php",maxConnections:999,onProgress:function(e,d,b,c){},onComplete:function(d,c,b){},onCancel:function(c,b){}};qq.extend(this._options,a);this._queue=[];this._params=[]};qq.UploadHandlerAbstract.prototype={log:function(a){if(this._options.debug&&window.console){console.log("[uploader] "+a)}},add:function(a){},upload:function(e,c,b){var a=this._queue.push(e);var d={};qq.extend(d,c);this._params[e]=d;if(a<=this._options.maxConnections){this._upload(e,this._params[e],b)}},cancel:function(a){this._cancel(a);this._dequeue(a)},cancelAll:function(){for(var a=0;a<this._queue.length;a++){this._cancel(this._queue[a])}this._queue=[]},getName:function(a){},getSize:function(a){},getQueue:function(){return this._queue},_upload:function(a){},_cancel:function(a){},_dequeue:function(d){var b=qq.indexOf(this._queue,d);this._queue.splice(b,1);var a=this._options.maxConnections;if(this._queue.length>=a){var c=this._queue[a-1];this._upload(c,this._params[c])}}};qq.UploadHandlerXhr=function(a){qq.UploadHandlerAbstract.apply(this,arguments);this._files=[];this._xhrs=[];this._loaded=[]};qq.UploadHandlerXhr.isSupported=function(){var a=document.createElement("input");a.type="file";return("multiple" in a&&typeof File!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined")};qq.extend(qq.UploadHandlerXhr.prototype,qq.UploadHandlerAbstract.prototype);qq.extend(qq.UploadHandlerXhr.prototype,{add:function(a){if(!(a instanceof File)){throw new Error("Passed obj in not a File (in qq.UploadHandlerXhr)")}return this._files.push(a)-1},getName:function(b){var a=this._files[b];return a.fileName!=null?a.fileName:a.name},getSize:function(b){var a=this._files[b];return a.fileSize!=null?a.fileSize:a.size},getLoaded:function(a){return this._loaded[a]||0},_upload:function(c,e,f){var d=this._files[c],b=this.getName(c),i=this.getSize(c);this._loaded[c]=0;var g=this._xhrs[c]=new XMLHttpRequest();var h=this;g.upload.onprogress=function(j){if(j.lengthComputable){h._loaded[c]=j.loaded;h._options.onProgress(c,b,j.loaded,j.total)}};g.onreadystatechange=function(){if(g.readyState==4){h._onComplete(c,g)}};e=e||{};var a=qq.obj2url(e,f||this._options.action);g.open(h._options.method,a,true);g.setRequestHeader("X-Requested-With","XMLHttpRequest");g.setRequestHeader("X-File-Name",encodeURIComponent(b));g.setRequestHeader("Content-Type",d.type||"application/octet-stream");g.setRequestHeader("Content-Disposition",'attachment; filename="'+b+'"');g.send(d)},_onComplete:function(id,xhr){if(!this._files[id]){return}var name=this.getName(id);var size=this.getSize(id);this._options.onProgress(id,name,size,size);if(xhr.status==200){this.log("xhr - server response received");this.log("responseText = "+xhr.responseText);var response;try{response=eval("("+xhr.responseText+")")}catch(err){response={}}this._options.onComplete(id,name,response)}else{this._options.onComplete(id,name,{})}this._files[id]=null;this._xhrs[id]=null;this._dequeue(id)},_cancel:function(a){this._options.onCancel(a,this.getName(a));this._files[a]=null;if(this._xhrs[a]){this._xhrs[a].abort();this._xhrs[a]=null}}});var FileCache=function(a){var b={};HC.observable(b);if(a.api_key===undefined){throw new Error("no api key provided")}var d,c;d=new qq.UploadHandlerXhr({method:"PUT",debug:true,onComplete:function(f,e){b.fire("loaded",e)},onProgress:function(h,g,e,f){b.fire("progress",e/f)}});b.cancel=function(){d.cancelAll();b.fire("canceled")};b.uploadURI=function(){return c};b.upload=function(e){c="https://filecache.hoccer.com/v3/"+HC.randomUUID();var f=d.add(e);d.upload(f,{expires_in:300,api_key:a.api_key},c);return{uri:c,type:e.type}};return b};
